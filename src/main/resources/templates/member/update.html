<!DOCTYPE html>
<html lang="kr">
<head th:replace="~{fragments/common :: head('회원 수정')}">
  <script defer="" src="/js/bootstrap.bundle.min.js"
          integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"></script>
</head>

<header>
  <!-- Fixed navbar -->
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark"
       th:replace="fragments/common :: menu('update')">
  </nav>
</header>
<!-- Bootstrap -->
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css">
</head>
<body class="p-5 container mt-5 ">
<h1>회원 정보 수정</h1>

<form id="updateForm" class="p-3 border rounded">
  <div class="mb-3">
    <label for="name" class="form-label">이름</label>
    <input id="name" name="name" type="text" class="form-control">
  </div>

  <div class="mb-3">
    <label for="email" class="form-label">이메일</label>
    <input id="email" name="email" type="text" class="form-control">
  </div>

  <div class="mb-3">
    <label for="password" class="form-label">비밀번호</label>
    <input id="password" name="password" type="text" class="form-control">
  </div>

  <div class="mb-3">
    <label for="city" class="form-label">도시</label>
    <input id="city" name="city" type="text" class="form-control">
  </div>


  <div class="mb-3">
    <label for="street" class="form-label">거리</label>
    <input id="street" name="street" type="text" class="form-control">
  </div>


  <div class="mb-3">
    <label for="zipcode" class="form-label">zipcode</label>
    <input id="zipcode" name="zipcode" type="text" class="form-control">
  </div>


  <button id="updateBtn" type="button"  class="btn btn-success float-end w-20 mt-4 me-0 btn-sm">
    회원수정
  </button>
</form>

<script>
  const token = localStorage.getItem("accessToken");
  // 페이지가 로드될 때 해당 회원 정보 가져오기
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch("/api/v1/members/me", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (res.ok) {
        const member = await res.json();

        document.getElementById('name').value = member.name;
        document.getElementById('email').value = member.email;
        document.getElementById('city').value = member.city;
        document.getElementById('street').value = member.street;
        document.getElementById('zipcode').value = member.zipcode;
      } else {
        alert('회원 정보를 불러올 수 없습니다');
      }
    } catch (err) {
      console.error(err);
      alert('회원 정보 요청 중 오류 발생');
    }
  });

  // 변경 버튼 클릭시 PUT 요청
  document.getElementById('updateBtn').addEventListener('click', async () => {
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const city = document.getElementById('city').value;
    const street = document.getElementById('street').value;
    const zipcode = document.getElementById('zipcode').value;

    const payload = {name , email, password, city, street, zipcode}; // 변경할 정보만 포함
   try {
      const res = await fetch(`/api/v1/members`, {
        method: 'PUT',
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        alert('회원 정보가 변경되었습니다');
        location.href = "/view/detail"
      } else {
        alert('회원 정보 변경 실패');
      }
    } catch (err) {
      console.error(err);
      alert('회원 정보 변경 중 오류 발생');
    }
  });
</script>
<script th:src="@{/js/navbar.js}"></script>
</body>
</html>