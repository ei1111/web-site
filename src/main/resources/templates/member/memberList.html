<!DOCTYPE html>
<html lang="ko" data-bs-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>회원 리스트 - ShopHub</title>

  <!-- fragments/common head 불러오기 -->
  <th:block th:replace="~{fragments/common :: head('회원 리스트')}"></th:block>

  <!-- Bootstrap Icons (다크모드 토글용) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root {
      --primary-start: #2563eb;
      --primary-end: #0891b2;
      --card-bg: rgba(255, 255, 255, 0.82);
      --card-border: rgba(203, 213, 225, 0.3);
      --shadow-md: 0 12px 40px rgba(0,0,0,0.12);
    }

    [data-bs-theme="dark"] {
      --card-bg: rgba(30, 41, 59, 0.72);
      --card-border: rgba(59, 69, 92, 0.4);
    }

    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
      min-height: 100vh;
      padding-top: 80px;
      color: #1e293b;
    }

    [data-bs-theme="dark"] body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
    }

    .page-header {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 1.75rem 2rem;
      margin-bottom: 2.5rem;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
    }

    .table-container {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
    }

    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      color: white;
      font-weight: 700;
      border: none;
      text-align: center;
      vertical-align: middle;
      padding: 1.1rem 0.9rem;
      font-size: 1rem;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background: rgba(37, 99, 235, 0.08);
      transform: translateY(-2px);
    }

    [data-bs-theme="dark"] .table tbody tr:hover {
      background: rgba(37, 99, 235, 0.18);
    }

    .table td {
      vertical-align: middle;
      padding: 1.1rem 0.9rem;
      border-top: 1px solid rgba(203, 213, 225, 0.3);
      color: #1e293b;
    }

    [data-bs-theme="dark"] .table td {
      color: #e2e8f0;
      border-top-color: rgba(59, 69, 92, 0.4);
    }

    .member-count {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
      font-size: 1.4rem;
    }

    .no-data {
      text-align: center;
      color: #94a3b8;
      padding: 4rem 0;
      font-size: 1.15rem;
      font-weight: 500;
    }

    .bd-mode-toggle .btn {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      border: none;
      box-shadow: 0 8px 25px rgba(37,99,235,0.3);
      border-radius: 50%;
      width: 52px;
      height: 52px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .page-header {
        padding: 1.5rem;
      }
      .table thead th,
      .table td {
        padding: 0.9rem 0.7rem;
        font-size: 0.94rem;
      }
    }
  </style>
</head>

<body>

<!-- 다크모드 토글 -->
<div class="dropdown position-fixed bottom-0 end-0 mb-5 me-4 bd-mode-toggle" style="z-index: 1030;">
  <button class="btn btn-primary shadow-lg" id="bd-theme" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Toggle theme">
    <i class="bi bi-circle-half fs-4"></i>
  </button>
  <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="bd-theme" style="border-radius: 12px; min-width: 140px;">
    <li><button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="light"><i class="bi bi-sun-fill me-2"></i> Light</button></li>
    <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark"><i class="bi bi-moon-stars-fill me-2"></i> Dark</button></li>
    <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto"><i class="bi bi-circle-half me-2"></i> Auto</button></li>
  </ul>
</div>

<!-- Navbar -->
<header th:replace="~{fragments/common :: menu('memberList')}"></header>

<main class="container py-5">

  <!-- 상단 헤더 영역 -->
  <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
      <h2 class="mb-1 fw-bold" th:text="#{member.list.title}">회원 리스트</h2>
      <p class="text-muted mb-0" th:text="#{member.list.desc}">전체 회원 목록 (관리자 전용)</p>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span class="fs-4 member-count" id="memberCount">0<span th:text="#{member.count.unit}">명</span></span>
    </div>
  </div>

  <!-- 테이블 컨테이너 -->
  <div class="table-container">
    <table class="table table-hover" id="memberTable">
      <thead>
      <tr>
        <th style="width: 8%;">#</th>
        <th style="width: 18%;" th:text="#{member.userId}">아이디</th>
        <th style="width: 15%;" th:text="#{member.name}">이름</th>
        <th style="width: 15%;" th:text="#{member.city}">도시</th>
        <th th:text="#{member.street}">도로명 주소</th>
        <th style="width: 14%;" th:text="#{member.zipcode}">우편번호</th>
      </tr>
      </thead>
      <tbody id="memberTbody">
      <!-- 데이터 없음 표시 -->
      <tr class="no-data-row" style="display: none;">
        <td colspan="6" class="no-data" th:text="#{member.no.data}">
          조회된 회원이 없습니다
        </td>
      </tr>
      </tbody>
    </table>
  </div>

</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- 다크모드 토글 스크립트 -->
<script>
  (() => {
    'use strict'

    const getStoredTheme = () => localStorage.getItem('theme')
    const setStoredTheme = theme => localStorage.setItem('theme', theme)

    const getPreferredTheme = () => {
      const storedTheme = getStoredTheme()
      if (storedTheme) return storedTheme
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
    }

    const setTheme = theme => {
      if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      } else {
        document.documentElement.setAttribute('data-bs-theme', theme)
      }
    }

    const showActiveTheme = theme => {
      const themeSwitcher = document.querySelector('#bd-theme')
      if (!themeSwitcher) return

      const icon = themeSwitcher.querySelector('i')
      if (theme === 'light') icon.className = 'bi bi-sun-fill fs-4'
      else if (theme === 'dark') icon.className = 'bi bi-moon-stars-fill fs-4'
      else icon.className = 'bi bi-circle-half fs-4'
    }

    setTheme(getPreferredTheme())
    showActiveTheme(getPreferredTheme())

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      const storedTheme = getStoredTheme()
      if (storedTheme !== 'light' && storedTheme !== 'dark') {
        setTheme(getPreferredTheme())
        showActiveTheme(getPreferredTheme())
      }
    })

    document.querySelectorAll('[data-bs-theme-value]').forEach(toggle => {
      toggle.addEventListener('click', () => {
        const theme = toggle.getAttribute('data-bs-theme-value')
        setStoredTheme(theme)
        setTheme(theme)
        showActiveTheme(theme)
      })
    })
  })()
</script>

<!-- 회원 리스트 불러오기 -->
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const token = localStorage.getItem("accessToken");
    const tbody = document.getElementById("memberTbody");
    const countEl = document.getElementById("memberCount");

    if (!token) {
      alert("로그인이 필요합니다.");
      window.location.href = "/view/login";
      return;
    }

    try {
      const response = await fetch("/api/v1/members", {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error("권한이 없습니다");
      }

      const members = await response.json();

      countEl.textContent = `${members.length}명`;

      if (members.length === 0) {
        document.querySelector(".no-data-row").style.display = "";
        return;
      }

      members.forEach((member, index) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="text-center fw-medium">${index + 1}</td>
          <td class="fw-medium">${member.userId}</td>
          <td>${member.name}</td>
          <td>${member.city || '-'}</td>
          <td>${member.street || '-'}</td>
          <td class="text-center">${member.zipcode || '-'}</td>
        `;

        tbody.appendChild(tr);
      });

    } catch (error) {
      console.error(error);
      alert("관리자만 접근 가능합니다.");
      window.location.href = "/";
    }
  });
</script>
</body>
</html>