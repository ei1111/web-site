<!DOCTYPE html>
<html lang="ko" data-bs-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>상품 목록 - ShopHub</title>

    <!-- fragments/common head 불러오기 -->
    <th:block th:replace="~{fragments/common :: head('상품등록')}"></th:block>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --primary-start: #2563eb;
            --primary-end: #0891b2;
            --card-bg: rgba(255, 255, 255, 0.82);
            --card-border: rgba(203, 213, 225, 0.3);
            --shadow-md: 0 12px 40px rgba(0,0,0,0.12);
        }

        [data-bs-theme="dark"] {
            --card-bg: rgba(30, 41, 59, 0.72);
            --card-border: rgba(59, 69, 92, 0.4);
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding-top: 80px;
            color: #1e293b;
        }

        [data-bs-theme="dark"] body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }

        .items-container {
            max-width: 1400px;
            margin: 2.5rem auto;
        }

        .page-header {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 1.75rem 2rem;
            margin-bottom: 2.5rem;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md);
        }

        .table-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md);
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            color: white;
            font-weight: 700;
            border: none;
            text-align: center;
            vertical-align: middle;
            padding: 1rem 0.75rem;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: rgba(37, 99, 235, 0.08);
            transform: translateY(-2px);
        }

        [data-bs-theme="dark"] .table tbody tr:hover {
            background: rgba(37, 99, 235, 0.18);
        }

        .table td {
            vertical-align: middle;
            padding: 0.75rem 0.6rem;
            border-top: 1px solid rgba(203, 213, 225, 0.3);
        }

        [data-bs-theme="dark"] .table td {
            border-top-color: rgba(59, 69, 92, 0.4);
        }

        .table img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid rgba(203, 213, 225, 0.5);
        }

        [data-bs-theme="dark"] .table img {
            border-color: rgba(59, 69, 92, 0.5);
        }

        .table th:nth-child(2) {
            width: 120px; /* 이미지 열 */
            text-align: center;
        }

        .table th:nth-child(3) {
            width: 30%;
        }

        .btn-edit {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            border: none;
            border-radius: 9999px;
            padding: 0.5rem 1.2rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 4px 15px rgba(37,99,235,0.25);
            transition: all 0.25s;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37,99,235,0.4);
        }

        .btn-create {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            border: none;
            border-radius: 9999px;
            padding: 0.75rem 1.8rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 8px 25px rgba(37,99,235,0.3);
            transition: all 0.3s;
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 35px rgba(37,99,235,0.45);
        }

        .no-items {
            text-align: center;
            padding: 5rem 1rem;
            color: #94a3b8;
            font-size: 1.3rem;
            font-weight: 500;
        }

        .bd-mode-toggle .btn {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            border: none;
            box-shadow: 0 8px 25px rgba(37,99,235,0.3);
            border-radius: 50%;
            width: 52px;
            height: 52px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .items-container {
                margin: 1.5rem 1rem;
            }
            .table th, .table td {
                padding: 0.6rem 0.5rem;
                font-size: 0.95rem;
            }
            .table img {
                width: 60px;
                height: 60px;
            }
            .table th:nth-child(2) {
                width: 100px;
            }
        }
    </style>
</head>

<body>

<!-- 다크모드 토글 -->
<div class="dropdown position-fixed bottom-0 end-0 mb-5 me-4 bd-mode-toggle" style="z-index: 1030;">
    <button class="btn btn-primary shadow-lg" id="bd-theme" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Toggle theme">
        <i class="bi bi-circle-half fs-4"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="bd-theme" style="border-radius: 12px; min-width: 140px;">
        <li><button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="light"><i class="bi bi-sun-fill me-2"></i> Light</button></li>
        <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark"><i class="bi bi-moon-stars-fill me-2"></i> Dark</button></li>
        <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto"><i class="bi bi-circle-half me-2"></i> Auto</button></li>
    </ul>
</div>

<!-- Navbar -->
<header th:replace="~{fragments/common :: menu('itemRegister')}"></header>

<main class="flex-shrink-0">
    <div class="items-container">

        <!-- 헤더 영역 -->
        <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-1 fw-bold" th:text="#{item.register.list}">상품 등록 목록</h2>
                <p class="text-muted mb-0" th:text="#{item.manage.desc}">등록된 모든 상품을 관리합니다</p>
            </div>
            <a href="/view/itemCreateForm" class="btn btn-create" th:text="'+ ' + #{item.create.title}">
                + 상품 등록
            </a>
        </div>

        <!-- 테이블 컨테이너 -->
        <div class="table-container">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th scope="col" style="width: 8%;">#</th>
                    <th scope="col" style="width: 12%;" th:text="#{item.image}">이미지</th>
                    <th scope="col" th:text="#{item.name}">상품명</th>
                    <th scope="col" style="width: 14%;" th:text="#{item.price}">가격</th>
                    <th scope="col" style="width: 14%;" th:text="#{item.stock}">재고수량</th>
                    <th scope="col" style="width: 10%;" th:text="#{board.manage}">관리</th>
                </tr>
                </thead>
                <tbody id="itemTableBody">
                <!-- JS로 채워짐 -->
                </tbody>
            </table>
        </div>

        <!-- 빈 상태 메시지 -->
        <div id="noItemsMessage" class="no-items" style="display: none;" th:text="#{item.no.items}">
            등록된 상품이 없습니다.
        </div>

    </div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- 다크모드 토글 스크립트 -->
<script>
    (() => {
        'use strict'
        const getStoredTheme = () => localStorage.getItem('theme')
        const setStoredTheme = theme => localStorage.setItem('theme', theme)
        const getPreferredTheme = () => {
            const storedTheme = getStoredTheme()
            if (storedTheme) return storedTheme
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }
        const setTheme = theme => {
            if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark')
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme)
            }
        }
        const showActiveTheme = theme => {
            const themeSwitcher = document.querySelector('#bd-theme')
            if (!themeSwitcher) return
            const icon = themeSwitcher.querySelector('i')
            if (theme === 'light') icon.className = 'bi bi-sun-fill fs-4'
            else if (theme === 'dark') icon.className = 'bi bi-moon-stars-fill fs-4'
            else icon.className = 'bi bi-circle-half fs-4'
        }
        setTheme(getPreferredTheme())
        showActiveTheme(getPreferredTheme())
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const storedTheme = getStoredTheme()
            if (storedTheme !== 'light' && storedTheme !== 'dark') {
                setTheme(getPreferredTheme())
                showActiveTheme(getPreferredTheme())
            }
        })
        document.querySelectorAll('[data-bs-theme-value]').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const theme = toggle.getAttribute('data-bs-theme-value')
                setStoredTheme(theme)
                setTheme(theme)
                showActiveTheme(theme)
            })
        })
    })()
</script>

<!-- 상품 목록 불러오기 -->
<script>
    const token = localStorage.getItem("accessToken");

    document.addEventListener("DOMContentLoaded", function () {
        fetchItems();
    });

    async function fetchItems() {
        try {
            const response = await fetch("/item/v1/list", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error("상품 목록을 불러오는데 실패했습니다.");
            }

            const data = await response.json();
            renderItems(data);

        } catch (error) {
            console.error('상품 목록 불러오기 실패:', error);
            document.getElementById('noItemsMessage').style.display = 'block';
        }
    }

    function renderItems(items) {
        const tbody = document.getElementById("itemTableBody");
        const noItemsMsg = document.getElementById('noItemsMessage');
        tbody.innerHTML = "";

        if (!items || items.length === 0) {
            noItemsMsg.style.display = 'block';
            return;
        }

        noItemsMsg.style.display = 'none';

        items.forEach(item => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
        <td class="text-center fw-medium">${item.rowNum || '-'}</td>
        <td class="text-center">
          <img src="${item.imagePath || '/images/no-image.png'}" alt="${item.name}">
        </td>
        <td class="fw-medium">${item.name}</td>
        <td class="text-end">${item.price.toLocaleString()}원</td>
        <td class="text-center">${item.stockQuantity.toLocaleString()}개</td>
        <td class="text-center">
          <a href="/view/${item.id}/edit" class="btn btn-edit btn-sm px-3">
            수정
          </a>
        </td>
      `;

            tbody.appendChild(tr);
        });
    }
</script>
</body>
</html>