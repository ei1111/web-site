<!DOCTYPE html>
<html lang="ko" data-bs-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>게시판 - ShopHub</title>

  <!-- fragments/common head 불러오기 -->
  <th:block th:replace="~{fragments/common :: head('게시판')}"></th:block>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root {
      --primary-start: #2563eb;
      --primary-end: #0891b2;
      --card-bg: rgba(255, 255, 255, 0.82);
      --card-border: rgba(203, 213, 225, 0.3);
      --shadow-md: 0 12px 40px rgba(0,0,0,0.12);
    }

    [data-bs-theme="dark"] {
      --card-bg: rgba(30, 41, 59, 0.72);
      --card-border: rgba(59, 69, 92, 0.4);
    }

    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
      min-height: 100vh;
      padding-top: 80px;
      color: #1e293b;
    }

    [data-bs-theme="dark"] body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
    }

    .board-container {
      max-width: 1100px;
      margin: 2.5rem auto;
    }

    .page-header {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 1.75rem 2rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
    }

    .table-container {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
    }

    .table thead th {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      color: white;
      font-weight: 700;
      border: none;
      text-align: center;
      vertical-align: middle;
      padding: 1.1rem;
    }

    .table tbody tr:hover {
      background: rgba(37, 99, 235, 0.08);
      transform: translateY(-2px);
    }

    [data-bs-theme="dark"] .table tbody tr:hover {
      background: rgba(37, 99, 235, 0.18);
    }

    .table td {
      vertical-align: middle;
      padding: 1.1rem;
      border-top: 1px solid rgba(203, 213, 225, 0.3);
    }

    [data-bs-theme="dark"] .table td {
      border-top-color: rgba(59, 69, 92, 0.4);
    }

    .table a {
      color: var(--primary-start);
      text-decoration: none;
      font-weight: 600;
    }

    .table a:hover {
      color: var(--primary-end);
      text-decoration: underline;
    }

    .btn-write {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      border: none;
      border-radius: 9999px;
      padding: 0.75rem 1.8rem;
      font-weight: 700;
      color: white;
      box-shadow: 0 8px 25px rgba(37,99,235,0.3);
      transition: all 0.3s ease;
    }

    .btn-write:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 35px rgba(37,99,235,0.45);
    }

    .btn-danger {
      border-radius: 9999px;
      font-weight: 600;
    }

    .pagination .page-link {
      border-radius: 8px;
      margin: 0 4px;
      color: var(--primary-start);
    }

    .pagination .page-item.active .page-link {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      border-color: transparent;
      color: white;
    }

    .bd-mode-toggle .btn {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      border: none;
      box-shadow: 0 8px 25px rgba(37,99,235,0.3);
      border-radius: 50%;
      width: 52px;
      height: 52px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 검색 폼 - 가로 배치 (검색창 옆에 버튼 바로 붙임) */
    .search-form {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1 1 auto;
      max-width: 600px;
    }

    .search-form .form-control {
      flex: 1 1 auto;
      min-width: 220px;
      border-radius: 12px 0 0 12px; /* 왼쪽 둥글게 */
    }

    .search-form .btn {
      background: var(--primary-start);
      border: none;
      color: white;
      border-radius: 0 12px 12px 0; /* 오른쪽 둥글게 */
      padding: 0.6rem 1.6rem;
      white-space: nowrap;
      transition: all 0.25s;
    }

    .search-form .btn:hover {
      background: var(--primary-end);
    }

    @media (max-width: 576px) {
      .search-form {
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 0.375rem;
      }
      .search-form .form-control,
      .search-form .btn {
        min-width: auto;
      }
    }
  </style>
</head>

<body>

<!-- 다크모드 토글 -->
<div class="dropdown position-fixed bottom-0 end-0 mb-5 me-4 bd-mode-toggle" style="z-index: 1030;">
  <button class="btn btn-primary shadow-lg" id="bd-theme" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Toggle theme">
    <i class="bi bi-circle-half fs-4"></i>
  </button>
  <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="bd-theme" style="border-radius: 12px; min-width: 140px;">
    <li><button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="light"><i class="bi bi-sun-fill me-2"></i> Light</button></li>
    <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark"><i class="bi bi-moon-stars-fill me-2"></i> Dark</button></li>
    <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto"><i class="bi bi-circle-half me-2"></i> Auto</button></li>
  </ul>
</div>

<!-- Navbar -->
<header th:replace="~{fragments/common :: menu('boardList')}"></header>

<main class="flex-shrink-0">
  <div class="board-container">

    <!-- 헤더 영역 -->
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h2 class="mb-1 fw-bold" th:text="#{board.title}">게시판</h2>
        <p class="text-muted mb-0" th:text="#{board.community.desc}">ShopHub 커뮤니티의 소통 공간</p>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="fs-5 fw-bold" style="background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
          <span th:text="#{board.total}">총</span> <span id="totalCount">0</span>건
        </span>
      </div>
    </div>

    <!-- 검색창 + 버튼 (가로 한 줄) + 글쓰기 버튼 -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <form id="searchForm" class="search-form">
        <input
            type="text"
            class="form-control"
            id="searchText"
            name="searchText"
            th:placeholder="#{board.search.placeholder}"
        >
        <button type="submit" class="btn px-4" th:text="#{button.search}">
          검색
        </button>
      </form>

      <a th:href="@{/view/write}" class="btn btn-write" th:text="#{board.write}">
        글쓰기
      </a>
    </div>

    <!-- 테이블 -->
    <div class="table-container">
      <table class="table table-hover">
        <thead>
        <tr>
          <th scope="col" style="width: 10%;" th:text="#{board.number}">번호</th>
          <th scope="col" th:text="#{board.subject}">제목</th>
          <th scope="col" style="width: 18%;" th:text="#{board.author}">작성자</th>
          <th scope="col" style="width: 12%;" th:text="#{board.manage}">관리</th>
        </tr>
        </thead>
        <tbody id="boardTableBody"></tbody>
      </table>
    </div>

    <!-- 페이지네이션 -->
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>

  </div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- 다크모드 토글 스크립트 -->
<script>
  (() => {
    'use strict'
    const getStoredTheme = () => localStorage.getItem('theme')
    const setStoredTheme = theme => localStorage.setItem('theme', theme)
    const getPreferredTheme = () => {
      const storedTheme = getStoredTheme()
      if (storedTheme) return storedTheme
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
    }
    const setTheme = theme => {
      if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      } else {
        document.documentElement.setAttribute('data-bs-theme', theme)
      }
    }
    const showActiveTheme = theme => {
      const themeSwitcher = document.querySelector('#bd-theme')
      if (!themeSwitcher) return
      const icon = themeSwitcher.querySelector('i')
      if (theme === 'light') icon.className = 'bi bi-sun-fill fs-4'
      else if (theme === 'dark') icon.className = 'bi bi-moon-stars-fill fs-4'
      else icon.className = 'bi bi-circle-half fs-4'
    }
    setTheme(getPreferredTheme())
    showActiveTheme(getPreferredTheme())
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      const storedTheme = getStoredTheme()
      if (storedTheme !== 'light' && storedTheme !== 'dark') {
        setTheme(getPreferredTheme())
        showActiveTheme(getPreferredTheme())
      }
    })
    document.querySelectorAll('[data-bs-theme-value]').forEach(toggle => {
      toggle.addEventListener('click', () => {
        const theme = toggle.getAttribute('data-bs-theme-value')
        setStoredTheme(theme)
        setTheme(theme)
        showActiveTheme(theme)
      })
    })
  })()
</script>

<!-- 게시판 스크립트 -->
<script th:inline="javascript">
  const token = localStorage.getItem("accessToken");
  let currentUserId = null;
  let currentSearchText = '';
  let currentPage = 0;

  document.addEventListener("DOMContentLoaded", async function () {
    await getCurrentUser();
    loadBoardList();

    document.getElementById("searchForm").addEventListener("submit", function (e) {
      e.preventDefault();
      currentSearchText = document.getElementById("searchText").value.trim();
      currentPage = 0;
      loadBoardList(currentPage, currentSearchText);
    });
  });

  async function getCurrentUser() {
    if (!token) return;
    try {
      const response = await fetch('/api/v1/members/me', {
        method: 'GET',
        headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        const data = await response.json();
        currentUserId = data.userId;
      }
    } catch (error) {
      console.error('사용자 정보 불러오기 실패:', error);
    }
  }

  function loadBoardList(page = 0, searchText = '') {
    currentPage = page;
    currentSearchText = searchText;
    const url = new URL('/api/v1/list', window.location.origin);
    url.searchParams.append('page', page);
    if (searchText) url.searchParams.append('searchText', searchText);

    fetch(url, {
      method: 'GET',
      headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` }
    })
    .then(response => response.json())
    .then(data => {
      renderTotalCount(data.totalCount || 0);
      renderBoardTable(data.boards || []);
      renderPagination(
          data.pageNumber || 0,
          data.totalPages || 1,
          data.startPage || 1,
          data.endPage || 1,
          searchText
      );
    })
    .catch(error => console.error('데이터 불러오기 실패:', error));
  }

  function renderTotalCount(count) {
    document.getElementById('totalCount').innerText = count;
  }

  function renderBoardTable(boards) {
    const tbody = document.getElementById('boardTableBody');
    tbody.innerHTML = '';

    if (boards.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center py-5 text-muted">등록된 게시글이 없습니다.</td></tr>`;
      return;
    }

    boards.forEach(board => {
      const tr = document.createElement('tr');
      const isAuthor = currentUserId && board.userId === currentUserId;
      const deleteButton = isAuthor
          ? `<button class="btn btn-danger btn-sm rounded-pill px-3" onclick="deleteBoard(${board.boardId})">삭제</button>`
          : '';

      tr.innerHTML = `
        <td class="text-center fw-medium">${board.rowNum}</td>
        <td><a href="/view/write?boardId=${board.boardId}">${board.title}</a></td>
        <td class="text-center">${board.userId}</td>
        <td class="text-center">${deleteButton}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteBoard(boardId) {
    if (!confirm('정말 삭제하시겠습니까?')) return;
    fetch(`/api/v1/form?boardId=${boardId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
      if (response.ok) {
        alert('삭제되었습니다.');
        loadBoardList(currentPage, currentSearchText);
      } else {
        return response.json().then(err => { throw new Error(err.message || '삭제 실패'); });
      }
    })
    .catch(error => {
      alert('삭제 중 오류가 발생했습니다: ' + error.message);
      console.error('삭제 실패:', error);
    });
  }

  function renderPagination(currentPage, totalPages, startPage, endPage, searchText = '') {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    const prevDisabled = currentPage === 0 ? 'disabled' : '';
    pagination.innerHTML += `
      <li class="page-item ${prevDisabled}">
        <a class="page-link" href="#" onclick="loadBoardList(${currentPage - 1}, '${searchText.replace(/'/g, "\\'")}')">Previous</a>
      </li>
    `;

    for (let i = startPage; i <= endPage; i++) {
      const active = (i - 1) === currentPage ? 'active' : '';
      pagination.innerHTML += `
        <li class="page-item ${active}">
          <a class="page-link" href="#" onclick="loadBoardList(${i - 1}, '${searchText.replace(/'/g, "\\'")}')">${i}</a>
        </li>
      `;
    }

    const nextDisabled = currentPage >= totalPages - 1 ? 'disabled' : '';
    pagination.innerHTML += `
      <li class="page-item ${nextDisabled}">
        <a class="page-link" href="#" onclick="loadBoardList(${currentPage + 1}, '${searchText.replace(/'/g, "\\'")}')">Next</a>
      </li>
    `;
  }
</script>

</body>
</html>