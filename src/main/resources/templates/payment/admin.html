<!DOCTYPE html>
<html lang="ko" data-bs-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>결제 내역 리스트 - ShopHub</title>

  <!-- fragments/common head 불러오기 -->
  <th:block th:replace="~{fragments/common :: head('결제내역리스트')}"></th:block>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- PortOne (아임포트) 결제 SDK -->
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

  <style>
    :root {
      --primary-start: #2563eb;
      --primary-end: #0891b2;
      --card-bg: rgba(255, 255, 255, 0.82);
      --card-border: rgba(203, 213, 225, 0.3);
      --shadow-md: 0 12px 40px rgba(0,0,0,0.12);
    }

    [data-bs-theme="dark"] {
      --card-bg: rgba(30, 41, 59, 0.72);
      --card-border: rgba(59, 69, 92, 0.4);
    }

    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
      min-height: 100vh;
      padding-top: 80px;
      color: #1e293b;
    }

    [data-bs-theme="dark"] body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
    }

    .order-container {
      max-width: 1600px;
      margin: 2.5rem auto;
    }

    .page-header {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 1.75rem 2rem;
      margin-bottom: 2.5rem;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
    }

    .table-container {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-md);
    }

    .dataTables_wrapper .dataTables_filter input {
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      padding: 0.5rem 1rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
      border-radius: 8px !important;
      margin: 0 3px;
      padding: 0.4rem 0.8rem !important;
      background: white !important;
      border: 1px solid #cbd5e1 !important;
      color: var(--primary-start) !important;
    }

    [data-bs-theme="dark"] .dataTables_wrapper .dataTables_paginate .paginate_button {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #93c5fd !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%) !important;
      border-color: transparent !important;
      color: white !important;
    }

    .dataTables_wrapper .dataTables_length select {
      border-radius: 8px;
      border: 1px solid #cbd5e1;
    }

    .table thead th {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      color: white;
      font-weight: 700;
      border: none;
      text-align: center;
      vertical-align: middle;
      padding: 1rem 0.75rem;
    }

    .table tbody tr:hover {
      background: rgba(37, 99, 235, 0.08);
    }

    [data-bs-theme="dark"] .table tbody tr:hover {
      background: rgba(37, 99, 235, 0.18);
    }

    .table td {
      vertical-align: middle;
      padding: 1rem 0.75rem;
      border-top: 1px solid rgba(203, 213, 225, 0.3);
    }

    [data-bs-theme="dark"] .table td {
      border-top-color: rgba(59, 69, 92, 0.4);
    }

    .status-ORDER { color: #2563eb; font-weight: 600; }
    .status-PAYMENT { color: #10b981; font-weight: 600; }
    .status-CANCEL { color: #9ca3af; font-weight: 600; text-decoration: line-through; }

    .btn-cancel-payment {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      border-radius: 9999px;
      padding: 0.5rem 1.2rem;
      font-weight: 600;
      color: white;
      box-shadow: 0 4px 15px rgba(239,68,68,0.3);
      transition: all 0.25s;
    }

    .btn-cancel-payment:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239,68,68,0.45);
    }

    .no-data {
      text-align: center;
      padding: 5rem 1rem;
      color: #94a3b8;
      font-size: 1.3rem;
      font-weight: 500;
    }

    .bd-mode-toggle .btn {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      border: none;
      box-shadow: 0 8px 25px rgba(37,99,235,0.3);
      border-radius: 50%;
      width: 52px;
      height: 52px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .order-container {
        margin: 1.5rem 1rem;
      }
      .table th, .table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.95rem;
      }
    }
  </style>
</head>

<body>

<!-- 다크모드 토글 -->
<div class="dropdown position-fixed bottom-0 end-0 mb-5 me-4 bd-mode-toggle" style="z-index: 1030;">
  <button class="btn btn-primary shadow-lg" id="bd-theme" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Toggle theme">
    <i class="bi bi-circle-half fs-4"></i>
  </button>
  <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="bd-theme" style="border-radius: 12px; min-width: 140px;">
    <li><button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="light"><i class="bi bi-sun-fill me-2"></i> Light</button></li>
    <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark"><i class="bi bi-moon-stars-fill me-2"></i> Dark</button></li>
    <li><button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto"><i class="bi bi-circle-half me-2"></i> Auto</button></li>
  </ul>
</div>

<!-- Navbar -->
<header th:replace="~{fragments/common :: menu('admin')}"></header>

<main class="flex-shrink-0">
  <div class="order-container">

    <!-- 헤더 영역 -->
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h2 class="mb-1 fw-bold">결제 내역 리스트</h2>
        <p class="text-muted mb-0">모든 결제 기록을 확인하고 관리합니다</p>
      </div>
      <div class="d-flex align-items-center gap-3">
        <!-- 필요 시 추가 버튼 -->
      </div>
    </div>

    <!-- 테이블 컨테이너 -->
    <div class="table-container">
      <table id="paymentTable" class="table table-hover display" style="width:100%">
        <thead>
        <tr>
          <th>ID</th>
          <th>Partner ID</th>
          <th>User ID</th>
          <th>Order ID</th>
          <th>결제금액</th>
          <th>결제일시</th>
          <th>impUid</th>
          <th>결제수단</th>
          <th>Merchant UID</th>
          <th>PG사</th>
          <th>PG 타입</th>
          <th>PG TID</th>
          <th>상태</th>
          <th>카드명</th>
          <th>카드번호</th>
          <th>생성일</th>
          <th>수정일</th>
          <th>관리</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- 빈 데이터 메시지 -->
    <div id="noDataMessage" class="no-data" style="display: none;">
      조회된 결제 내역이 없습니다.
    </div>

  </div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- 다크모드 토글 스크립트 -->
<script>
  (() => {
    'use strict'
    const getStoredTheme = () => localStorage.getItem('theme')
    const setStoredTheme = theme => localStorage.setItem('theme', theme)
    const getPreferredTheme = () => {
      const storedTheme = getStoredTheme()
      if (storedTheme) return storedTheme
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
    }
    const setTheme = theme => {
      if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-bs-theme', 'dark')
      } else {
        document.documentElement.setAttribute('data-bs-theme', theme)
      }
    }
    const showActiveTheme = theme => {
      const themeSwitcher = document.querySelector('#bd-theme')
      if (!themeSwitcher) return
      const icon = themeSwitcher.querySelector('i')
      if (theme === 'light') icon.className = 'bi bi-sun-fill fs-4'
      else if (theme === 'dark') icon.className = 'bi bi-moon-stars-fill fs-4'
      else icon.className = 'bi bi-circle-half fs-4'
    }
    setTheme(getPreferredTheme())
    showActiveTheme(getPreferredTheme())
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      const storedTheme = getStoredTheme()
      if (storedTheme !== 'light' && storedTheme !== 'dark') {
        setTheme(getPreferredTheme())
        showActiveTheme(getPreferredTheme())
      }
    })
    document.querySelectorAll('[data-bs-theme-value]').forEach(toggle => {
      toggle.addEventListener('click', () => {
        const theme = toggle.getAttribute('data-bs-theme-value')
        setStoredTheme(theme)
        setTheme(theme)
        showActiveTheme(theme)
      })
    })
  })()
</script>

<!-- DataTables + 결제 취소 스크립트 -->
<script>
  const token = localStorage.getItem("accessToken");

  $(document).ready(function() {
    const table = $('#paymentTable').DataTable({
      "paging": true,
      "searching": true,
      "ordering": true,
      "info": true,
      "language": {
        "lengthMenu": "_MENU_ 건씩 보기",
        "search": "검색:",
        "zeroRecords": "조회된 결제 내역이 없습니다.",
        "info": "총 _TOTAL_건 중 _START_ ~ _END_ 표시",
        "infoEmpty": "데이터가 없습니다.",
        "infoFiltered": "(_MAX_건 중 필터링됨)",
        "paginate": {
          "first": "처음",
          "last": "마지막",
          "next": "다음",
          "previous": "이전"
        }
      },
      "ajax": {
        "url": "/api/payment/list",
        "type": "GET",
        "headers": {
          "Authorization": `Bearer ${token}`
        },
        "dataSrc": ""
      },
      "columns": [
        { "data": "id" },
        { "data": "partnerId" },
        { "data": "userId" },
        { "data": "orderId" },
        { "data": "paymentAmount", render: function(data) { return data.toLocaleString() + '원'; } },
        { "data": "paymentDate" },
        { "data": "impUid" },
        { "data": "paymentMethod" },
        { "data": "merchantUid" },
        { "data": "pgProvider" },
        { "data": "pgType" },
        { "data": "pgTid" },
        {
          "data": "status",
          "render": function(data) {
            let badgeClass = '';
            if (data === 'COMPLETED') badgeClass = 'bg-success';
            else if (data === 'CANCELLED') badgeClass = 'bg-danger';
            else if (data === 'PENDING') badgeClass = 'bg-warning';
            else badgeClass = 'bg-secondary';
            return `<span class="badge ${badgeClass}">${data}</span>`;
          }
        },
        { "data": "cardName" },
        { "data": "cardNumber" },
        { "data": "createdAt" },
        { "data": "updatedAt" },
        {
          "data": null,
          "render": function(data, type, row) {
            if (row.status !== 'CANCELLED') {
              return `<button class="btn btn-cancel-payment btn-sm px-3" data-imp-uid="${row.impUid}">결제 취소</button>`;
            }
            return '';
          }
        }
      ],
      "order": [[0, "desc"]], // 기본 정렬: ID 내림차순
      "pageLength": 10
    });

    // 결제 취소 버튼 클릭 이벤트
    $('#paymentTable tbody').on('click', '.btn-cancel-payment', async function() {
      const impUid = $(this).data('imp-uid');

      if (!confirm(`impUid: ${impUid}\n정말 결제를 취소하시겠습니까?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/payment/cancle/${impUid}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${token}`
          }
        });

        if (response.ok) {
          alert("결제 취소가 성공적으로 처리되었습니다.");
          table.ajax.reload(); // 테이블 새로고침
        } else {
          const error = await response.json();
          alert("결제 취소 실패: " + (error.message || "잠시 후 다시 시도해주세요."));
        }
      } catch (error) {
        console.error("취소 오류:", error);
        alert("결제 취소 처리 중 오류가 발생했습니다.");
      }
    });
  });
</script>

<script th:src="@{/js/navbar.js}"></script>

</body>
</html>